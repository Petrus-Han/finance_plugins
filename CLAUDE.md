# CLAUDE.md

本文件为 Claude 提供 Finance Plugins 项目的上下文和开发指南。

## 项目概述

Finance Plugins 是一组 Dify 插件，用于实现 Mercury 银行与 QuickBooks 的集成：

- `mercury_tools_plugin` - Mercury 银行 API 工具集（账户、交易、收款人等）
- `mercury_trigger_plugin` - Mercury Webhook 触发器（交易事件同步）

## 本项目文档

| 文档 | 用途 |
|------|------|
| `Mercury_API_Documentation.md` | Mercury 银行 API 文档 |
| `QuickBooks_API_Documentation.md` | QuickBooks API 文档 |
| `solution-design.md` | 技术方案详细设计 |

## 财务安全合规要求

本项目处理银行账户和财务数据，必须遵守以下合规要求：

### 1. 数据分类与保护

**敏感数据类型**：
- 银行账户号码、路由号码
- API 凭证（Access Token、Refresh Token、API Key）
- OAuth Client Secret
- 交易金额和明细
- 个人身份信息（姓名、地址、税号等）

**保护措施**：
- 敏感数据在传输中必须加密（TLS 1.2+）
- 敏感数据不得明文存储在代码、配置文件或日志中
- 遵循最小权限原则，仅请求业务必需的数据

### 2. 认证与授权

- 所有 API 调用必须经过认证
- OAuth Token 需设置合理的过期时间
- Refresh Token 需安全存储，不得暴露给客户端
- 实现 Token 自动刷新机制，避免服务中断
- Webhook 请求必须验证签名，防止伪造

### 3. 日志与审计

**必须记录**：
- 所有金融操作的时间戳（UTC）
- 操作类型和结果（成功/失败）
- 脱敏后的业务标识符
- 错误代码和非敏感错误信息

**禁止记录**：
- 完整的账户号码（仅允许后 4 位）
- Access Token、Refresh Token、API Key
- 完整的交易金额明细
- 个人身份信息

### 4. 数据脱敏规则

- 银行账户号码：仅显示后 4 位，如 `****1234`
- 路由号码：仅显示后 4 位
- API Token：仅记录是否存在（true/false）
- 金额：审计日志中可记录，调试日志中禁止

### 5. 错误处理

- 错误消息不得包含内部系统路径
- 错误消息不得包含数据库查询或 API 响应原文
- 错误消息不得包含凭证信息
- 区分用户可见错误和内部日志错误

### 6. 传输安全

- 所有外部 API 调用必须使用 HTTPS
- 禁止禁用 SSL/TLS 证书验证
- 设置合理的请求超时（建议 15-30 秒）
- 实现请求重试时使用指数退避

### 7. 输入验证

- 验证所有外部输入的格式和范围
- 账户 ID、交易 ID 需验证格式
- 金额需验证为正数且在合理范围内
- 日期需验证格式和有效性
- 防止注入攻击（SQL、命令、SSRF）

### 8. 幂等性与一致性

- 金融操作必须实现幂等性
- 使用唯一业务标识符进行去重
- 避免重复处理同一笔交易
- 操作失败时确保状态一致

### 9. 速率限制

- 遵守第三方 API 的速率限制
- 实现客户端限流，避免超限
- 监控 API 配额使用情况

### 10. 代码审查检查清单

- [ ] 无硬编码凭证或密钥
- [ ] 日志中无敏感数据
- [ ] 所有外部输入已验证
- [ ] 错误消息不暴露内部细节
- [ ] API 调用使用 HTTPS
- [ ] 设置了请求超时
- [ ] Webhook 签名已验证
- [ ] 金融操作具有幂等性

### 11. 禁止事项

- 在代码、注释、配置中写入真实凭证
- 将任何凭证提交到版本控制
- 禁用 SSL/TLS 证书验证
- 在日志中记录完整凭证或账户信息
- 实现绕过认证授权的后门
- 在 URL 参数中传递敏感信息
- 存储超出业务需要的个人数据

## Git 工作流规范

- **禁止直接在 main 分支提交代码**：必须根据当前任务新建功能分支
- **分支命名规范**：`feature/<功能名>`, `fix/<问题描述>`, `chore/<维护任务>`
- **提交 PR 前必须确保**：单元测试和集成测试全部通过
- **PR 合并后删除功能分支**

## 注意事项

- **优先参考官方插件**：不要凭空实现，先找类似示例
- **保持代码简洁**：遵循 KISS 原则，不要过度设计
- **严格遵守安全合规**：上述安全规范是强制性要求，不可妥协

# Mercury Trigger 测试指南

本文档介绍如何在客户端测试 Mercury Trigger Plugin。

## 环境信息

| 组件 | 地址 |
|------|------|
| Dify 控制台 | https://dify.greeep.com |
| Mock Mercury Server | http://dify.greeep.com:8765 |
| Mock API Token | `mock_token_12345` |

## 前提条件

1. Mock Mercury Server 正在运行
2. Mercury Trigger Plugin 已连接到 Dify
3. 端口 8765 已对外开放

---

## 测试步骤

### 第一步：验证 Mock Server 可访问

```bash
curl http://dify.greeep.com:8765/status
```

预期返回：
```json
{
  "service": "Mock Mercury Server",
  "version": "1.1.0",
  "status": "running",
  "api_token": "mock_token_12345",
  "registered_webhooks": 0,
  "simulated_transactions": 0
}
```

---

### 第二步：登录 Dify 控制台

1. 打开浏览器访问：https://dify.greeep.com
2. 使用以下账号登录：
   - 账号: `test@greeep.com`
   - 密码: `claude123123`

---

### 第三步：创建 Workflow

1. 点击左侧 **工作室 (Studio)**
2. 点击 **创建应用**
3. 选择 **Workflow** 类型
4. 输入应用名称，如 "Mercury Transaction Test"
5. 点击 **创建**

---

### 第四步：配置 Mercury Trigger

1. 在 Workflow 编辑器中，点击 **开始** 节点
2. 选择 **添加触发器**
3. 找到并选择 **Mercury Transaction Trigger**

4. 配置凭证信息：

| 字段 | 值 |
|------|-----|
| API Environment | `Mock (Local Testing)` |
| Mock Server URL | `http://dify.greeep.com:8765` |
| Access Token | `mock_token_12345` |

5. 配置订阅参数：

| 字段 | 值 |
|------|-----|
| Event Types | 勾选 `Transaction Created` 和/或 `Transaction Updated` |
| Filter Paths | 留空（可选） |

6. 点击 **保存**

---

### 第五步：添加处理节点（可选）

为了验证触发器工作正常，可以添加一个简单的处理节点：

#### 方案 A：添加代码节点

1. 在触发器后添加 **代码** 节点
2. 输入以下代码：

```python
def main(event_id: str, transaction_id: str, amount: float,
         counterparty_name: str, operation_type: str) -> dict:
    return {
        "result": f"收到 {operation_type} 事件",
        "transaction_id": transaction_id,
        "amount": amount,
        "counterparty": counterparty_name
    }
```

3. 配置输入变量映射

#### 方案 B：添加 LLM 节点

1. 在触发器后添加 **LLM** 节点
2. 在提示词中引用触发器输出变量：

```
收到一笔新交易：
- 交易ID: {{transaction_id}}
- 金额: {{amount}}
- 对方: {{counterparty_name}}
- 状态: {{status}}

请简要描述这笔交易。
```

---

### 第六步：发布 Workflow

1. 点击右上角 **发布** 按钮
2. 确认发布

> 注意：只有发布后的 Workflow 才会创建 webhook 订阅

---

### 第七步：验证 Webhook 注册

发布后，在客户端执行：

```bash
curl http://dify.greeep.com:8765/webhooks/list
```

预期返回（包含已注册的 webhook）：
```json
{
  "webhooks": [
    {
      "id": "wh_xxxxxxxxxxxx",
      "url": "https://dify.greeep.com/v1/triggers/webhook/...",
      "secret": "base64-encoded-secret",
      "status": "active",
      "eventTypes": ["transaction.created", "transaction.updated"]
    }
  ],
  "count": 1
}
```

---

### 第八步：触发测试事件

#### 模拟 transaction.created 事件

```bash
curl -X POST http://dify.greeep.com:8765/simulate/transaction \
  -H "Content-Type: application/json" \
  -d '{
    "amount": -888.88,
    "counterparty": "测试供应商",
    "status": "pending"
  }'
```

#### 模拟 transaction.updated 事件

```bash
curl -X POST http://dify.greeep.com:8765/simulate/transaction/update \
  -H "Content-Type: application/json" \
  -d '{
    "amount": -888.88,
    "counterparty": "测试供应商",
    "status": "sent"
  }'
```

#### 自定义金额和对方名称

```bash
curl -X POST http://dify.greeep.com:8765/simulate/transaction \
  -H "Content-Type: application/json" \
  -d '{
    "amount": -12345.67,
    "counterparty": "阿里云",
    "status": "pending",
    "account_id": "acc_mock_checking_001"
  }'
```

---

### 第九步：查看执行结果

1. 回到 Dify 控制台
2. 进入你的 Workflow 应用
3. 点击 **日志** 或 **监控**
4. 查看最新的执行记录
5. 点击记录查看详细的输入输出

---

## 触发器输出变量

当 webhook 被触发时，以下变量可供后续节点使用：

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `event_id` | string | Mercury 事件 ID |
| `transaction_id` | string | 交易 ID |
| `operation_type` | string | 操作类型：`created` 或 `updated` |
| `account_id` | string | Mercury 账户 ID |
| `amount` | number | 交易金额（负数为支出） |
| `status` | string | 交易状态 |
| `posted_at` | string | 入账时间（ISO 格式） |
| `counterparty_name` | string | 对方名称 |
| `bank_description` | string | 银行描述 |
| `note` | string | 交易备注 |
| `category` | string | 分类 |
| `transaction_type` | string | 交易类型 |

---

## 常用命令

```bash
# 检查 Mock Server 状态
curl http://dify.greeep.com:8765/status

# 查看所有已注册的 webhooks
curl http://dify.greeep.com:8765/webhooks/list

# 触发 transaction.created 事件
curl -X POST http://dify.greeep.com:8765/simulate/transaction \
  -H "Content-Type: application/json" \
  -d '{"amount": -500, "counterparty": "Acme Corp"}'

# 触发 transaction.updated 事件
curl -X POST http://dify.greeep.com:8765/simulate/transaction/update \
  -H "Content-Type: application/json" \
  -d '{"status": "sent"}'

# 发送自定义事件
curl -X POST http://dify.greeep.com:8765/simulate/custom \
  -H "Content-Type: application/json" \
  -d '{
    "id": "evt_custom_001",
    "resourceType": "transaction",
    "operationType": "created",
    "resourceId": "txn_custom_001",
    "mergePatch": {
      "amount": -999.99,
      "counterpartyName": "Custom Vendor"
    }
  }'

# 清除所有 webhooks（重置测试环境）
curl -X POST http://dify.greeep.com:8765/webhooks/clear

# 查看 Mercury 账户（测试 API）
curl -H "Authorization: Bearer mock_token_12345" \
  http://dify.greeep.com:8765/api/v1/accounts
```

---

## 故障排查

### Webhook 未注册

**症状**: `/webhooks/list` 返回空数组

**排查步骤**:
1. 确认 Workflow 已发布
2. 检查 Trigger 凭证配置是否正确
3. 查看 Dify 控制台是否有错误提示

### 事件触发但 Workflow 未执行

**症状**: `simulate/transaction` 返回成功但 Workflow 无日志

**排查步骤**:
1. 检查 webhook 的 URL 是否可访问
2. 查看 Mock Server 终端输出的 delivery_results
3. 确认 eventTypes 配置与触发的事件类型匹配

### 签名验证失败

**症状**: Workflow 日志显示签名验证错误

**排查步骤**:
1. 确认 Mock Server 和 Trigger 使用相同的签名算法
2. 检查 webhook secret 是否正确传递

---

## 附录：Mock Server API 参考

### Mercury API 端点

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/v1/accounts` | 获取账户列表 |
| GET | `/api/v1/account/{id}` | 获取账户详情 |
| GET | `/api/v1/account/{id}/transactions` | 获取交易列表 |
| GET | `/api/v1/recipients` | 获取收款人列表 |
| GET | `/api/v1/recipient/{id}` | 获取收款人详情 |
| POST | `/api/v1/recipients` | 创建收款人 |
| GET | `/api/v1/categories` | 获取分类列表 |
| GET | `/api/v1/webhooks` | 获取 webhook 列表 |
| POST | `/api/v1/webhooks` | 创建 webhook |
| GET | `/api/v1/webhook/{id}` | 获取 webhook 详情 |
| DELETE | `/api/v1/webhook/{id}` | 删除 webhook |

### 模拟端点

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/simulate/transaction` | 模拟 transaction.created |
| POST | `/simulate/transaction/update` | 模拟 transaction.updated |
| POST | `/simulate/custom` | 发送自定义事件 |

### 工具端点

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/status` | 服务状态 |
| GET | `/webhooks/list` | 列出 webhooks（无需认证） |
| POST | `/webhooks/clear` | 清除所有 webhooks |
